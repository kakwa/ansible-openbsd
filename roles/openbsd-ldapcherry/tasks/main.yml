---
# LdapCherry in a virtualenv (OpenBSD only)

- name: Ensure Python 3 for ldapcherry virtualenv
  community.general.openbsd_pkg:
    name: python3
    state: present

- name: Create _ldapcherry user
  ansible.builtin.user:
    name: _ldapcherry
    system: true
    shell: /usr/sbin/nologin
    create_home: false

- name: Ensure ldapcherry config directory exists
  file:
    path: /etc/ldapcherry
    state: directory
    mode: "0755"
    owner: root
    group: root

- name: Ensure ldapcherry venv parent directory exists
  file:
    path: "{{ ldapcherry_venv_dir.rsplit('/', 1)[0] }}"
    state: directory
    mode: "0755"
    owner: root
    group: _ldapcherry

- name: Create ldapcherry virtualenv
  ansible.builtin.command:
    cmd: "{{ ansible_python.executable }} -m venv {{ ldapcherry_venv_dir }}"
    creates: "{{ ldapcherry_venv_dir }}/bin/python"

- name: Install ldapcherry from git (virtualenv)
  ansible.builtin.pip:
    name: "git+{{ ldapcherry_git_url }}"
    state: present
    virtualenv: "{{ ldapcherry_venv_dir }}"

- name: Get ldapcherry package directory (templates/static) from virtualenv
  ansible.builtin.command:
    cmd: "{{ ldapcherry_venv_dir }}/bin/python -c 'import ldapcherry, os; print(os.path.dirname(ldapcherry.__file__))'"
  register: _ldapcherry_pkg_dir
  changed_when: false

- name: Set ldapcherry_share_dir from virtualenv
  ansible.builtin.set_fact:
    ldapcherry_share_dir: "{{ _ldapcherry_pkg_dir.stdout }}"

- name: Set ownership of virtualenv to _ldapcherry (for daemon)
  ansible.builtin.file:
    path: "{{ ldapcherry_venv_dir }}"
    owner: root
    group: _ldapcherry
    mode: "0750"
    recurse: true

- name: Deploy ldapcherry.ini
  template:
    src: ldapcherry.ini.j2
    dest: /etc/ldapcherry/ldapcherry.ini
    owner: root
    group: _ldapcherry
    mode: "0640"
  notify: restart ldapcherry

- name: Deploy attributes.yml for ldapcherry
  template:
    src: attributes.yml.j2
    dest: /etc/ldapcherry/attributes.yml
    owner: root
    group: root
    mode: "0644"
  notify: restart ldapcherry

- name: Deploy roles.yml for ldapcherry
  template:
    src: roles.yml.j2
    dest: /etc/ldapcherry/roles.yml
    owner: root
    group: root
    mode: "0644"
  notify: restart ldapcherry

- name: Install ldapcherry rc.d script
  ansible.builtin.template:
    src: ldapcherry.rc.j2
    dest: /etc/rc.d/ldapcherry
    owner: root
    group: wheel
    mode: "0755"
  notify: restart ldapcherry

- name: Ensure ldapcherry service is started and enabled
  service:
    name: ldapcherry
    state: started
    enabled: true

# Nginx reverse proxy for ldapcherry
- name: Install nginx
  community.general.openbsd_pkg:
    name: nginx
    state: present
  when: ldapcherry_nginx_enable | default(true) | bool

- name: Ensure nginx SSL cert directory exists for ldapcherry
  file:
    path: "{{ ldapcherry_nginx_ssl_cert_dir }}"
    state: directory
    mode: "0750"
    owner: root
    group: root
  when: ldapcherry_nginx_enable | default(true) | bool and ldapcherry_nginx_ssl_enable | default(false) | bool

- name: Generate self-signed SSL certificate for ldapcherry nginx
  command: >-
    openssl req -x509 -nodes -days {{ ldapcherry_nginx_ssl_valid_days }}
    -newkey rsa:2048
    -keyout {{ ldapcherry_nginx_ssl_key }}
    -out {{ ldapcherry_nginx_ssl_cert }}
    -subj "/CN={{ ldapcherry_nginx_ssl_self_signed_cn }}"
  args:
    creates: "{{ ldapcherry_nginx_ssl_cert }}"
  when: ldapcherry_nginx_enable | default(true) | bool and ldapcherry_nginx_ssl_enable | default(false) | bool
  notify: reload nginx

- name: Deploy nginx config for ldapcherry
  template:
    src: nginx-ldapcherry.conf.j2
    dest: "{{ ldapcherry_nginx_config_path }}"
    owner: root
    group: root
    mode: "0644"
  notify: reload nginx
  when: ldapcherry_nginx_enable | default(true) | bool

- name: Include ldapcherry config in nginx.conf
  ansible.builtin.lineinfile:
    path: /etc/nginx/nginx.conf
    insertafter: '^\s*http\s*\{'
    line: '    include {{ ldapcherry_nginx_config_path }};'
    state: present
    regexp: '^\s*include\s+{{ ldapcherry_nginx_config_path | regex_escape }}\s*;'
  when: ldapcherry_nginx_enable | default(true) | bool
  notify: reload nginx

- name: Ensure nginx is started and enabled
  service:
    name: nginx
    state: started
    enabled: true
  when: ldapcherry_nginx_enable | default(true) | bool
