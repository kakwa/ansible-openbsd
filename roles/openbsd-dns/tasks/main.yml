---
# Internal DNS: Knot DNS (OpenBSD)
# Tag "named" = Knot DNS; tag "dns" = both

# --- Knot DNS (OpenBSD) ---
- name: Stop and disable NSD (migrating to Knot)
  ansible.builtin.service:
    name: nsd
    state: stopped
    enabled: false
  when: ansible_facts.os_family == "OpenBSD"
  failed_when: false
  tags: named

- name: Stop and disable BIND (migrating to Knot)
  ansible.builtin.service:
    name: isc_named
    state: stopped
    enabled: false
  when: ansible_facts.os_family == "OpenBSD"
  failed_when: false
  tags: named

- name: Install Knot DNS (OpenBSD)
  community.general.openbsd_pkg:
    name: "{{ internal_dns_knot_package }}"
    state: present
  when: ansible_facts.os_family == "OpenBSD"
  tags: named

- name: Ensure Knot directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ internal_dns_knot_conf_dir }}", owner: "root", group: "_knot", mode: "0750" }
    - { path: "{{ internal_dns_knot_zone_dir }}", owner: "_knot", group: "_knot", mode: "0770" }
    - { path: "{{ internal_dns_knot_storage_dir }}", owner: "_knot", group: "_knot", mode: "0770" }
    - { path: "/var/run/knot", owner: "_knot", group: "_knot", mode: "0770" }
  when: ansible_facts.os_family == "OpenBSD"
  tags: named

- name: Deploy Knot config
  ansible.builtin.template:
    src: knot.conf.j2
    dest: "{{ internal_dns_knot_conf }}"
    owner: root
    group: _knot
    mode: "0640"
  when: ansible_facts.os_family == "OpenBSD"
  tags: named
  notify: Reload knot

- name: Deploy Unbound config
  ansible.builtin.template:
    src: unbound.conf.j2
    dest: "{{ internal_dns_unbound_conf }}"
    owner: root
    group: _unbound
    mode: "0640"
  when: ansible_facts.os_family == "OpenBSD"
  tags: named
  notify: Reload unbound

- name: Deploy Unbound deny list
  ansible.builtin.copy:
    src: adblock.conf
    dest: "{{ internal_dns_unbound_deny }}"
    owner: root
    group: _unbound
    mode: "0640"
  when: ansible_facts.os_family == "OpenBSD"
  tags: named
  notify: Reload unbound

- name: Deploy zone file for {{ internal_dns_zone }} (Knot)
  ansible.builtin.template:
    src: zone-master.j2
    dest: "{{ internal_dns_knot_storage_dir }}/{{ internal_dns_zone }}.zone"
    owner: _knot
    group: _knot
    mode: "0640"
  when: ansible_facts.os_family == "OpenBSD"
  tags: named
  notify: Reload knot

- name: Enable and start unbound (forward queries to Knot on port 5353)
  ansible.builtin.service:
    name: unbound
    state: started
    enabled: true
  when: ansible_facts.os_family == "OpenBSD"
  tags: named

- name: Enable and start Knot DNS (OpenBSD)
  ansible.builtin.service:
    name: knot
    state: started
    enabled: true
  when: ansible_facts.os_family == "OpenBSD"
  tags: named
